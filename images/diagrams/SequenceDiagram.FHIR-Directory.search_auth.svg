<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="603.125px" preserveAspectRatio="none" style="width:1653px;height:603px;background:#FFFFFF;" version="1.1" viewBox="0 0 1653 603" width="1653.125px" zoomAndPan="magnify"><defs/><g><rect fill="#F5F5F5" height="591.569" style="stroke:#181818;stroke-width:0.5208333333333334;" width="146.875" x="634.375" y="6.25"/><text fill="#000000" font-family="sans-serif" font-size="16.6667" font-weight="bold" lengthAdjust="spacing" textLength="135.4167" x="637.5" y="21.7204">FHIR-Directory</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="5.2083" x="772.9167" y="22.4574">Â </text><rect fill="#FFFFFF" height="453.5319" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="217.1875" y="72.8353"/><rect fill="#FFFFFF" height="285.7585" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="702.6042" y="240.6087"/><rect fill="#FFFFFF" height="72.88" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1556.7708" y="121.6187"/><rect fill="#FFFFFF" height="46.11" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1556.7708" y="374.4954"/><line style="stroke:#181818;stroke-width:0.5208333333333334;stroke-dasharray:5.0,5.0;" x1="221.875" x2="221.875" y1="62.4186" y2="545.1172"/><line style="stroke:#181818;stroke-width:0.5208333333333334;stroke-dasharray:5.0,5.0;" x1="707.2917" x2="707.2917" y1="62.4186" y2="545.1172"/><line style="stroke:#181818;stroke-width:0.5208333333333334;stroke-dasharray:5.0,5.0;" x1="1561.9792" x2="1561.9792" y1="62.4186" y2="545.1172"/><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="159.375" x="142.7083" y="29.8177"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="144.7917" x="150" y="50.646">TI-Messenger-Client</text><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="159.375" x="142.7083" y="544.0755"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="144.7917" x="150" y="564.9038">TI-Messenger-Client</text><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="105.2083" x="655.2083" y="29.8177"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="90.625" x="662.5" y="50.646">Auth-Service</text><rect fill="#E3E3E3" height="31.5592" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="105.2083" x="655.2083" y="544.0755"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="90.625" x="662.5" y="564.9038">Auth-Service</text><rect fill="#E3E3E3" height="48.5352" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="170.8333" x="1476.5625" y="12.8418"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="156.25" x="1483.8542" y="33.67">TI-Messenger-Service</text><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="125" x="1499.4792" y="50.646">Messenger-Proxy</text><rect fill="#E3E3E3" height="48.5352" rx="2.6042" ry="2.6042" style="stroke:#181818;stroke-width:0.5208333333333334;" width="170.8333" x="1476.5625" y="544.0755"/><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="156.25" x="1483.8542" y="564.9038">TI-Messenger-Service</text><text fill="#000000" font-family="sans-serif" font-size="14.5833" lengthAdjust="spacing" textLength="125" x="1499.4792" y="581.8797">Messenger-Proxy</text><rect fill="#FFFFFF" height="453.5319" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="217.1875" y="72.8353"/><rect fill="#FFFFFF" height="285.7585" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="702.6042" y="240.6087"/><rect fill="#FFFFFF" height="72.88" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1556.7708" y="121.6187"/><rect fill="#FFFFFF" height="46.11" style="stroke:#181818;stroke-width:1.0416666666666667;" width="10.4167" x="1556.7708" y="374.4954"/><polygon fill="#181818" points="1544.2708,117.452,1554.6875,121.6187,1544.2708,125.7853,1548.4375,121.6187" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="227.6042" x2="1550.5208" y1="121.6187" y2="121.6187"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.25" x="234.8958" y="116.3417">[01]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="396.875" x="270.3125" y="116.3417">POST /_matrix/client/v3/user/{userId}/openid/request_token</text><path d="M5.2083,78.0436 L5.2083,150.9603 L212.5,150.9603 L212.5,88.4603 L202.0833,78.0436 L5.2083,78.0436 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5208333333333334;"/><path d="M202.0833,78.0436 L202.0833,88.4603 L212.5,88.4603 L202.0833,78.0436 " fill="#FAFAFA" style="stroke:#181818;stroke-width:0.5208333333333334;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="86.4583" x="11.4583" y="95.8216">Precondition:</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="172.9167" x="11.4583" y="111.585">The user is logged in &amp; no</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="181.25" x="11.4583" y="127.3483">search-accesstoken for the</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="137.5" x="11.4583" y="143.1117">FHIR-Directory exists</text><polygon fill="#181818" points="239.0625,190.332,228.6458,194.4987,239.0625,198.6654,234.8958,194.4987" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="232.8125" x2="1560.9375" y1="194.4987" y2="194.4987"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.25" x="245.3125" y="181.34">[02]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="500" x="280.7292" y="173.4584">HTTP 200 OK, Result body {"access_token": "OFdZNozDIomXLrCWjgejIQBM"</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="344.7917" x="284.8958" y="189.2217">,..., "matrix_server_name": "matrix.service-ti.de",...}</text><polygon fill="#181818" points="690.1042,236.4421,700.5208,240.6087,690.1042,244.7754,694.2708,240.6087" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="227.6042" x2="696.3542" y1="240.6087" y2="240.6087"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.25" x="234.8958" y="227.4501">[03]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="330.2083" x="270.3125" y="219.5684">GET /tim-authenticate?mxId=matrix.service-ti.de"</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="388.5417" x="274.4792" y="235.3317">-H "X-Matrix-OpenID-Token: OFdZNozDIomXLrCWjgejIQBM"</text><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="713.0208" x2="756.7708" y1="286.7188" y2="286.7188"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="756.7708" x2="756.7708" y1="286.7188" y2="300.2604"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="714.0625" x2="756.7708" y1="300.2604" y2="300.2604"/><polygon fill="#181818" points="724.4792,296.0938,714.0625,300.2604,724.4792,304.4271,720.3125,300.2604" style="stroke:#181818;stroke-width:1.0416666666666667;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.25" x="720.3125" y="273.5601">[04]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="328.125" x="755.7292" y="265.6784">Check that matrix server url "matrix.service-ti.de"</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="179.1667" x="759.8958" y="281.4418">is part of the federation list</text><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="713.0208" x2="756.7708" y1="330.6071" y2="330.6071"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="756.7708" x2="756.7708" y1="330.6071" y2="344.1488"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="714.0625" x2="756.7708" y1="344.1488" y2="344.1488"/><polygon fill="#181818" points="724.4792,339.9821,714.0625,344.1488,724.4792,348.3154,720.3125,344.1488" style="stroke:#181818;stroke-width:1.0416666666666667;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.25" x="720.3125" y="325.3301">[05]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="257.2917" x="755.7292" y="325.3301">lookup PORT for given matrix server url</text><polygon fill="#181818" points="1544.2708,370.3288,1554.6875,374.4954,1544.2708,378.6621,1548.4375,374.4954" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="713.0208" x2="1550.5208" y1="374.4954" y2="374.4954"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.25" x="720.3125" y="369.2184">[06]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="771.875" x="755.7292" y="369.2184">GET matrix.service-ti.de:{PORT}/_matrix/federation/v1/openid/userinfo?access_token=OFdZNozDIomXLrCWjgejIQBM</text><polygon fill="#181818" points="724.4792,416.4388,714.0625,420.6055,724.4792,424.7721,720.3125,420.6055" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="718.2292" x2="1560.9375" y1="420.6055" y2="420.6055"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.25" x="730.7292" y="407.4468">[07]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="85.4167" x="766.1458" y="399.5651">HTTP 200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="353.125" x="766.1458" y="415.3285">Result Body {"sub": "@testuser:matrix.service-ti.de"}</text><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="713.0208" x2="756.7708" y1="450.9521" y2="450.9521"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="756.7708" x2="756.7708" y1="450.9521" y2="464.4938"/><line style="stroke:#181818;stroke-width:1.0416666666666667;" x1="714.0625" x2="756.7708" y1="464.4938" y2="464.4938"/><polygon fill="#181818" points="724.4792,460.3271,714.0625,464.4938,724.4792,468.6605,720.3125,464.4938" style="stroke:#181818;stroke-width:1.0416666666666667;"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.25" x="720.3125" y="445.6752">[08]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="339.5833" x="755.7292" y="445.6752">Create search-accesstoken for TI-Messenger-Client</text><polygon fill="#181818" points="233.8542,522.2005,223.4375,526.3672,233.8542,530.5339,229.6875,526.3672" style="stroke:#181818;stroke-width:1.0416666666666667;"/><line style="stroke:#181818;stroke-width:1.0416666666666667;stroke-dasharray:2.0,2.0;" x1="227.6042" x2="706.7708" y1="526.3672" y2="526.3672"/><text fill="#000000" font-family="sans-serif" font-size="13.5417" font-weight="bold" lengthAdjust="spacing" textLength="31.25" x="240.1042" y="505.3268">[09]</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="170.8333" x="275.5208" y="489.5635">HTTP 200 OK, Result body</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="397.9167" x="275.5208" y="505.3268">{"access_token"="eyJ0eXAiOiJKV1...", "token_type":"bearer",</text><text fill="#000000" font-family="sans-serif" font-size="13.5417" lengthAdjust="spacing" textLength="131.25" x="275.5208" y="521.0902">"expires_in":86400}</text><!--MD5=[0ec886f6981c258b43a27d98f90893f5]
@startuml SequenceDiagram.FHIR-Directory.search.auth
skinparam dpi 100
skinparam WrapWidth 200
skinparam monochrome true
autonumber "<b>[00]"

'title "FHIR-Directory, Sequenzdiagram search token exchange'
participant cl as "TI-Messenger-Client"
box <size:16>FHIR-Directory</size> #WhiteSmoke
  participant au as "Auth-Service"
end box
participant hs as "TI-Messenger-Service\nMessenger-Proxy"
activate cl
cl -> hs: POST /_matrix/client/v3/user/{userId}/openid/request_token
note left
Precondition: 
The user is logged in & no search-accesstoken for the FHIR-Directory exists
end note
activate hs
hs - -> cl: HTTP 200 OK, Result body {"access_token": "OFdZNozDIomXLrCWjgejIQBM" \n ,..., "matrix_server_name": "matrix.service-ti.de",...}
deactivate hs
cl -> au: GET /tim-authenticate?mxId=matrix.service-ti.de" \n -H "X-Matrix-OpenID-Token: OFdZNozDIomXLrCWjgejIQBM"
activate au
au -> au: Check that matrix server url "matrix.service-ti.de"\n is part of the federation list
au -> au: lookup PORT for given matrix server url
au -> hs: GET matrix.service-ti.de:{PORT}/_matrix/federation/v1/openid/userinfo?access_token=OFdZNozDIomXLrCWjgejIQBM
activate hs
hs - -> au: HTTP 200 OK\nResult Body {"sub": "@testuser:matrix.service-ti.de"}
deactivate hs
au -> au: Create search-accesstoken for TI-Messenger-Client
au - -> cl: HTTP 200 OK, Result body\n{"access_token"="eyJ0eXAiOiJKV1...", "token_type":"bearer",\n"expires_in":86400}
deactivate au
deactivate cl
@enduml

@startuml SequenceDiagram.FHIR-Directory.search.auth
skinparam dpi 100
skinparam WrapWidth 200
skinparam monochrome true
autonumber "<b>[00]"

participant cl as "TI-Messenger-Client"
box <size:16>FHIR-Directory</size> #WhiteSmoke
  participant au as "Auth-Service"
end box
participant hs as "TI-Messenger-Service\nMessenger-Proxy"
activate cl
cl -> hs: POST /_matrix/client/v3/user/{userId}/openid/request_token
note left
Precondition: 
The user is logged in & no search-accesstoken for the FHIR-Directory exists
end note
activate hs
hs - -> cl: HTTP 200 OK, Result body {"access_token": "OFdZNozDIomXLrCWjgejIQBM" \n ,..., "matrix_server_name": "matrix.service-ti.de",...}
deactivate hs
cl -> au: GET /tim-authenticate?mxId=matrix.service-ti.de" \n -H "X-Matrix-OpenID-Token: OFdZNozDIomXLrCWjgejIQBM"
activate au
au -> au: Check that matrix server url "matrix.service-ti.de"\n is part of the federation list
au -> au: lookup PORT for given matrix server url
au -> hs: GET matrix.service-ti.de:{PORT}/_matrix/federation/v1/openid/userinfo?access_token=OFdZNozDIomXLrCWjgejIQBM
activate hs
hs - -> au: HTTP 200 OK\nResult Body {"sub": "@testuser:matrix.service-ti.de"}
deactivate hs
au -> au: Create search-accesstoken for TI-Messenger-Client
au - -> cl: HTTP 200 OK, Result body\n{"access_token"="eyJ0eXAiOiJKV1...", "token_type":"bearer",\n"expires_in":86400}
deactivate au
deactivate cl
@enduml

PlantUML version 1.2022.13(Sat Nov 19 13:22:17 UTC 2022)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>